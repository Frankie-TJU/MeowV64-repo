VERILATOR = verilator
GMP_CFLAGS = $(shell pkg-config --cflags gmp)
GMP_LDFLAGS = $(shell pkg-config --libs gmp)
VERILATOR_FLAGS = -Wno-fatal --trace-fst --timescale-override 1ns/1ns -CFLAGS "$(GMP_CFLAGS)" -LDFLAGS "$(GMP_LDFLAGS) -lgmp -lgmpxx"
CURRENT_DIR = $(shell pwd)
VERILOG_SRCS = RiscVSystem.v

all: VRiscVSystem

$(VERILOG_SRCS):
	cd ../../ && mill meowv64.runMain meowv64.Main $(CONFIG) -td $(CURRENT_DIR)

VRiscVSystem: ../main.cpp $(VERILOG_SRCS)
	$(VERILATOR) $(VERILATOR_FLAGS) --cc $(VERILOG_SRCS) --exe $<
	make -j8 -C obj_dir -f VRiscVSystem.mk VRiscVSystem
	cp obj_dir/VRiscVSystem .

clean:
	rm -rf $(VERILOG_SRCS) obj_dir